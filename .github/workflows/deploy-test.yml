name: Deploy to Test Environment

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

env:
  AZURE_RESOURCE_GROUP: rg-fredesa-dev
  AZURE_LOCATION: eastus2
  BACKEND_APP_NAME: fredesa-api-test
  FRONTEND_APP_NAME: fredesa-web-test
  REGISTRY_NAME: fredesaregistry

jobs:
  build-and-deploy:
    name: Build and Deploy to Test
    runs-on: ubuntu-latest
    environment:
      name: test
      url: https://fredesa-web-test.eastus.azurecontainerapps.io
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:test-${{ github.sha }}
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:test-latest
          cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:test-latest
          cache-to: type=inline
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          build-args: |
            VITE_API_URL=https://fredesa-api-test.eastus.azurecontainerapps.io
          tags: |
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:test-${{ github.sha }}
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:test-latest
          cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:test-latest
          cache-to: type=inline
      
      - name: Deploy backend to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:test-${{ github.sha }} \
            --set-env-vars \
              ENVIRONMENT=test \
              DATABASE_URL="${{ secrets.TEST_DATABASE_URL }}" \
              REDIS_URL="${{ secrets.TEST_REDIS_URL }}" \
              AZURE_CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}" \
              AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
      
      - name: Deploy frontend to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:test-${{ github.sha }}
      
      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for deployment to stabilize..."
          sleep 60
      
      - name: Run smoke tests
        run: |
          # Test backend health
          BACKEND_URL="https://fredesa-api-test.eastus.azurecontainerapps.io"
          echo "Testing backend health endpoint..."
          curl -f ${BACKEND_URL}/health || exit 1
          
          # Test frontend
          FRONTEND_URL="https://fredesa-web-test.eastus.azurecontainerapps.io"
          echo "Testing frontend..."
          curl -f ${FRONTEND_URL} || exit 1
          
          echo "‚úÖ Smoke tests passed!"
      
      - name: Notify deployment success
        if: success()
        run: |
          echo "üöÄ Deployment to test environment successful!"
          echo "Backend: https://fredesa-api-test.eastus.azurecontainerapps.io"
          echo "Frontend: https://fredesa-web-test.eastus.azurecontainerapps.io"
          echo "Commit: ${{ github.sha }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-deployment from develop branch' }}"
      
      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deployment to test environment failed!"
          echo "Check logs for details"
          exit 1
