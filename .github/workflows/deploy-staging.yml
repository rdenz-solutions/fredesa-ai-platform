name: Deploy to Staging Environment

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version/tag to deploy'
        required: true
        default: 'latest'
      reason:
        description: 'Reason for deployment'
        required: true

env:
  AZURE_RESOURCE_GROUP: rg-fredesa-staging
  AZURE_LOCATION: eastus2
  BACKEND_APP_NAME: fredesa-api-staging
  FRONTEND_APP_NAME: fredesa-web-staging
  REGISTRY_NAME: fredesaregistry

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Validate version/tag
        run: |
          echo "Validating version: ${{ github.event.inputs.version }}"
          if [[ "${{ github.event.inputs.version }}" == "latest" ]]; then
            echo "âœ… Deploying latest version from main branch"
          else
            # Check if tag exists
            git fetch --tags
            if git rev-parse "${{ github.event.inputs.version }}" >/dev/null 2>&1; then
              echo "âœ… Tag ${{ github.event.inputs.version }} exists"
            else
              echo "âŒ Tag ${{ github.event.inputs.version }} not found"
              exit 1
            fi
          fi
      
      - name: Check test environment health
        run: |
          echo "Checking test environment health before staging deployment..."
          BACKEND_URL="https://fredesa-api-test.eastus.azurecontainerapps.io"
          HEALTH_STATUS=$(curl -s ${BACKEND_URL}/health | jq -r '.status')
          
          if [[ "$HEALTH_STATUS" == "healthy" ]]; then
            echo "âœ… Test environment is healthy"
          else
            echo "âš ï¸  Test environment is not healthy, but proceeding with staging deployment"
          fi
  
  build-and-deploy:
    name: Build and Deploy to Staging
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://fredesa-web-staging.eastus.azurecontainerapps.io
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version == 'latest' && 'main' || github.event.inputs.version }}
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Get commit SHA
        id: sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:staging-${{ steps.sha.outputs.sha }}
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:staging-latest
          cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:staging-latest
          cache-to: type=inline
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          build-args: |
            VITE_API_URL=https://fredesa-api-staging.eastus.azurecontainerapps.io
          tags: |
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:staging-${{ steps.sha.outputs.sha }}
            ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:staging-latest
          cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:staging-latest
          cache-to: type=inline
      
      - name: Deploy backend (Blue-Green)
        run: |
          # Create new revision
          az containerapp update \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-backend:staging-${{ steps.sha.outputs.sha }} \
            --set-env-vars \
              ENVIRONMENT=staging \
              DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}" \
              REDIS_URL="${{ secrets.STAGING_REDIS_URL }}" \
              AZURE_CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}" \
              AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --revision-suffix ${{ steps.sha.outputs.sha }}
          
          # Get revision name
          REVISION_NAME=$(az containerapp revision list \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          echo "New backend revision: ${REVISION_NAME}"
      
      - name: Deploy frontend (Blue-Green)
        run: |
          az containerapp update \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_NAME }}.azurecr.io/fredesa-frontend:staging-${{ steps.sha.outputs.sha }} \
            --revision-suffix ${{ steps.sha.outputs.sha }}
      
      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for deployment to stabilize..."
          sleep 90
      
      - name: Run health checks
        id: health_check
        run: |
          BACKEND_URL="https://fredesa-api-staging.eastus.azurecontainerapps.io"
          
          # Test health endpoint
          echo "Testing health endpoint..."
          for i in {1..5}; do
            if curl -f ${BACKEND_URL}/health; then
              echo "âœ… Health check passed"
              break
            else
              echo "â³ Health check attempt $i/5 failed, retrying..."
              sleep 10
            fi
            
            if [ $i -eq 5 ]; then
              echo "âŒ Health checks failed after 5 attempts"
              exit 1
            fi
          done
      
      - name: Run smoke tests
        run: |
          BACKEND_URL="https://fredesa-api-staging.eastus.azurecontainerapps.io"
          FRONTEND_URL="https://fredesa-web-staging.eastus.azurecontainerapps.io"
          
          # Test API endpoints
          echo "Testing API docs..."
          curl -f ${BACKEND_URL}/docs || exit 1
          
          # Test frontend
          echo "Testing frontend..."
          curl -f ${FRONTEND_URL} || exit 1
          
          echo "âœ… Smoke tests passed!"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed, initiating rollback..."
          
          # Get previous revision
          PREVIOUS_REVISION=$(az containerapp revision list \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[1].name" -o tsv)
          
          echo "Rolling back to: ${PREVIOUS_REVISION}"
          
          # Activate previous revision
          az containerapp revision activate \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --revision ${PREVIOUS_REVISION}
          
          echo "âœ… Rollback completed"
          exit 1
      
      - name: Create deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.sha.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://fredesa-api-staging.eastus.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://fredesa-web-staging.eastus.azurecontainerapps.io" >> $GITHUB_STEP_SUMMARY
